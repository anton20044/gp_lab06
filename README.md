| **<br/>Лабораторная работа №6 по курсу "Greenplum для разработчиков и архитекторов баз данных"<br/>"Настройка репликации сегментов и мониторинга"<br/>**|
|---|

<br/>

## Задание:
### На уже развернутом кластере Greenplum произведите зеркалирование данных как для вычислительных нод, так и для мастер-ноды
### Проверьте статус репликации через системные утилиты.
### Разверните и настройте подключение Grafana и Greenplum через Prometheus.
### Произведите симуляцию падения сегментной ноды.
### Убедитесь, что БД не упала, и mirror-сегменты включены.
### Устраните проблему, поднимите primary-сегменты и произведите ребалансировку данных.


<br/>

## Решение:
* Развернут кластер ArenadataDB состоящий из мастера, стендбай и 4 сегментных серверов, на которых присутствую по 4 первичных сегмента и по 4 зеркалированных сегментов (итого 16 первичных сегментов, всего сегментов 32)

![i1](image/laa06_01.jpg)

![i2](image/laa06_02.jpg) 

* Проверил состояние репликации мастера
```
select * from pg_stat_replication \gx
```

![i3](image/laa06_03.jpg) 

* Проверил состояние репликации сегмента
```
select * from pg_stat_replication \gx
```

![i4](image/laa06_04.jpg) 

* В качестве решения по мониторингу кластера воспользовался готовым бандлом Grafana + Prometheus от Arenadata

![i5](image/laa06_05.jpg) 

* Создал таблицу, вставил в нее данные
```
create table test_fail (id int) distributed by (id);
insert into test_fail select * from generate_series(1,1000000);
select count(*) from test_fail ;
```

![i6](image/laa06_06.jpg) 

* После этого выключил произвольный сегмент
```
/usr/lib/gpdb/bin/pg_ctl stop -m fast -D /data1/primary/gpseg1/
```

![i7](image/laa06_07.jpg) 

* Включил обратно сегмент
```
/usr/lib/gpdb/bin/pg_ctl start -D /data1/primary/gpseg1/
```

* Выполнил восстановление сегмента 
```
gprecoverseg -F
```

![i8](image/laa06_08.jpg)

* Выполнил ребалансинг
```
gprecoverseg -r
```

![i9](image/laa06_09.jpg) 

* После этого все сегменты встали на свои места

![i10](image/laa06_10.jpg) 

* На момент отсутствия одного сегмента делал выборки из таблицы, все данные были на месте

![i11](image/laa06_11.jpg) 
